<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Repeater test</title>
	<link rel="stylesheet" href="../../../../dijit/themes/claro/claro.css">
</head>
<body class="claro">
	<script src="../../../../dojo/dojo.js"></script>
	<script>
		require({
			paths: {
				frb: "../frb-amd",
				collections: "../collections-amd",
			}
		},[
			"../Repeater.js",
			"dojo/_base/declare",
			"SkFramework/component/DomComponent",
			"frb/bind",
			"dojo/on",
			"frb/dom",
			// 'dojo/domReady!',
		], function(Repeater, declare, DomComponent, bind, on){

			window.repeater = new Repeater({
				domTag: "ul",
				componentConstructorArguments: {domTag: "li"},
			});
			document.body.appendChild(repeater.render());
			repeater.set('inDom');

			window.collection = ["a", "b", "c"];
			window.repeaterDomChildren = repeater.domNode.children;

			function assertDomUpdated (){
				console.assert(collection.length === repeaterDomChildren.length, "Collection and dom nodes are not the same lentgh");
				collection.forEach(function(value, index){
					console.assert(repeaterDomChildren[index].innerHTML === value, "A value is not in dom", value);
				});
			}

			// set a non empty collection
			repeater.set("value", collection);
			assertDomUpdated();


			// change a value in collection
			collection.set(2, "deux");
			assertDomUpdated();

			// push a new value in collection
			collection.push("c");
			assertDomUpdated();

			// remove and insert many values in collection
			collection.splice(1, 2, "splice1", "splice2", "splice3");
			assertDomUpdated();

			//sort collection
			collection.sort();
			assertDomUpdated();

			// remove one value at the beginning of the collection
			//check that its internal binding is canceled
			var c = repeater._componentsCollection[0];
			collection.shift();
			assertDomUpdated();
			console.assert(Object.getOwnPropertyDescriptor(c._presenter, "value").set === undefined);

			//remove many values from the collection
			collection.splice(1, 3);
			assertDomUpdated();

			//set an empty collection
			collection = [];
			repeater.set("value", collection);
			assertDomUpdated();

			// set a new non empty collection in the repeater
			collection = ["un", "deux", "trois"];
			repeater.set("value", collection);
			assertDomUpdated();

			//destroy repeater
			repeater.destroy();
			//check that the value binding is canceled
			//certainly not the best way, but I check that the setter installed by frb is well removed
			console.assert(Object.getOwnPropertyDescriptor(repeater._presenter, "value").set === undefined);


			// other tests with object items

			syv = {name: "Sylvain", child: "false", sexe: "M"};
			aur = {name: "Aurélie", child: "false", sexe:"F"};
			ant = {name: "Antonin", child: true, sexe:"M"};
			leo = {name: "Léonie", child: true, sexe:"F"};
			collection = [syv, aur, ant];

			InputComponent = declare(DomComponent, {
				domTag: "input",
				constructor: function(){
					this._cancelValueBinding = bind(this, "domNode.value", {"<->": "_presenter.value.name"});
				},
				destroy: function(){
					this._cancelValueBinding();
					this.inherited(arguments);
				},
			});

			repeater = new Repeater({
				// value: collection, // why can we not do that ?
				componentConstructor: InputComponent,
			});
			document.body.appendChild(repeater.render());
			repeater.set("value", collection);
			repeater.set('inDom');

			repeaterDomChildren = repeater.domNode.children;
			function assertDomInputUpdated (){
				console.assert(collection.length === repeaterDomChildren.length, "Collection and dom nodes are not the same lentgh");
				collection.forEach(function(value, index){
					console.assert(repeaterDomChildren[index].value === value.name, "A value is not in dom", value);
				});
			}

			//check that initial collection is well rendered
			assertDomInputUpdated();

			// add and remove values in collection
			collection.splice(1,2, leo);
			assertDomInputUpdated();

			// change one value in collection
			collection.set(0, aur);
			assertDomInputUpdated();

			// change a value property
			aur.name = "Aur";
			assertDomInputUpdated();

			// simulate a change from user
			window.input = repeater._componentsCollection[0].domNode
			input.value = "Aurélie";
			on.emit(input, "change", {});
			assertDomInputUpdated();




		});
	</script>
</body>
</html>